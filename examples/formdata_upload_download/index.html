<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Files!</title>
</head>
<body>
  <div>
    <form enctype="multipart/form-data">
      <input id="file-upload" type="file" name="_file_"/>
      <button id="upload">Submit</button>
    </form>
    <div id="uploaded">
    </div>
  </div>
  <script>
    let fileUpload = document.getElementById("file-upload");
    let uploadedFiles = document.getElementById("uploaded");

    // a deletion handler which removes the upload entry from the DOM and makes
    // a request to the backend to delete the file.
    const deleteUpload = (upload, filename) => {
      fetch(`/delete?_file_=${filename}`, {
        method: "GET",
      })
      .then((resp) => {
        if (resp.status != 200) {
          alert(`An error occurred. Server says:\n${respTxt}`);
          return;
        }
      })
      .catch(async (e) => {
        alert(`An unexpected error occurred: ${e}`);
        return;
      });
      uploadedFiles.removeChild(upload);
    }

    document.getElementById("upload").onclick = function(e) {
      e.preventDefault();
      // check if there are any files to upload
      if (fileUpload.files.length === 0) {
        alert("Please chose a file to upload");
        return;
      }
      // populate formdata object with file selected
      let fd = new FormData();
      fd.append("_file_", fileUpload.files[0]);
      // send formdata object to backend and handle outcome
      fetch("/upload", {
        method: "POST",
        body: fd,
      })
      .then(async (resp) => {
        let newUpload = document.createElement("div");
        let respTxt = await resp.text();
        let href = `/download?_file_=${respTxt}`;

        if (resp.status != 200) {
          alert(`An error occurred. Server says:\n${respTxt}`);
          return;
        }

        newUpload.innerHTML = `
        ${fileUpload.files[0].name} ->
          <a target="_blank" href=${href}>${respTxt}</a>
          <button id="del-${respTxt}">Delete</button>
        `;
        uploadedFiles.appendChild(newUpload);
        // set up upload deletion handler
        document.getElementById(`del-${respTxt}`).onclick = () =>
          deleteUpload(newUpload, respTxt);
      })
      .catch(async (e) => {
        alert(`An unexpected error occurred: ${e}`);
      });
    };
  </script>
</body>
</html>
